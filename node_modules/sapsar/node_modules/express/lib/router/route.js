/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var debug=require("debug")("express:router:route"),flatten=require("array-flatten"),Layer=require("./layer"),methods=require("methods"),slice=Array.prototype.slice,toString=Object.prototype.toString;function Route(path){this.path=path,this.stack=[],debug("new %o",path),this.methods={}}module.exports=Route,Route.prototype._handles_method=function(method){if(this.methods._all)return!0;var name=method.toLowerCase();return"head"!==name||this.methods.head||(name="get"),Boolean(this.methods[name])},Route.prototype._options=function(){var methods=Object.keys(this.methods);this.methods.get&&!this.methods.head&&methods.push("head");for(var i=0;i<methods.length;i++)methods[i]=methods[i].toUpperCase();return methods},Route.prototype.dispatch=function(req,res,done){var idx=0,stack=this.stack,sync=0;if(0===stack.length)return done();var method=req.method.toLowerCase();function next(err){if(err&&"route"===err)return done();if(err&&"router"===err)return done(err);if(++sync>100)return setImmediate(next,err);var layer=stack[idx++];if(!layer)return done(err);layer.method&&layer.method!==method?next(err):err?layer.handle_error(err,req,res,next):layer.handle_request(req,res,next),sync=0}"head"!==method||this.methods.head||(method="get"),req.route=this,next()},Route.prototype.all=function(){for(var handles=flatten(slice.call(arguments)),i=0;i<handles.length;i++){var handle=handles[i];if("function"!=typeof handle){var type=toString.call(handle);throw new TypeError("Route.all() requires a callback function but got a "+type)}var layer=Layer("/",{},handle);layer.method=void 0,this.methods._all=!0,this.stack.push(layer)}return this},methods.forEach((function(method){Route.prototype[method]=function(){for(var handles=flatten(slice.call(arguments)),i=0;i<handles.length;i++){var handle=handles[i];if("function"!=typeof handle){var type=toString.call(handle);throw new Error("Route."+method+"() requires a callback function but got a "+type)}debug("%s %o",method,this.path);var layer=Layer("/",{},handle);layer.method=method,this.methods[method]=!0,this.stack.push(layer)}return this}}));